---
title: "Summary figures"
author: "Julianna Renzi"
date: "3/16/2021"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: lumen
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(tidyverse) # data manipulation
require(here) # for relative paths
require(RColorBrewer) # for colors
require(patchwork) # combining figures

# for map making:
require(sf)
require(rnaturalearth) # map of the world
require(tmap) # interactive plotting
require(ggspatial) # north arrows and scale bar
```

# Make a plot of publications through time

Bring in the data and count up publications by year

```{r}
# bring in the data
time <- read_csv(here("data", "Corallivore_year_exptype.csv"))

time_sum <- time %>% 
  group_by(Year, Exp_type) %>% 
  summarize(Publications = n()) # get the count of publications per year

# duration of the graph we want
min_yr <- 1976
max_yr <- 2020

# create a dataframe of all possible values to join
all_years <- data.frame(Year = c(seq(min_yr, max_yr, by = 1),
                                seq(min_yr, max_yr, by = 1),
                                seq(min_yr, max_yr, by = 1)),
                        Exp_type = c(rep("Experimental", times = max_yr-min_yr+1),
                                     rep("Observational", times = max_yr-min_yr+1),
                                     rep("Both", times = max_yr-min_yr+1))) # create a df to join so that every year is accounted for (=0 if there are no publications)

time_full <- all_years %>% 
  full_join(time_sum, by = c("Year", "Exp_type")) %>% # join the two dataframes so there's a line for every year
  mutate(Publications = replace_na(Publications, 0)) # replace the NA's for 0 in the years where nothing was published

  
```


Plot the results

```{r}

time_plt <- time_full %>% 
  ggplot(aes(x = Year, y = Publications, fill = fct_reorder(Exp_type, desc(Exp_type)))) + # fct_reorder() so both is the last in the legend (makes the most sense)
  geom_bar(stat = "identity") +
  ylab("Number of studies") +
  geom_hline(yintercept = 0) + # create an x-axis that is distinct
  theme_minimal()  +
  scale_fill_manual(name = "", # no legend title 
                    values = rev(brewer.pal(n = 3, name = "YlOrBr"))) +
  scale_x_continuous(breaks = seq(min_yr, max_yr, by = 2)) + # create a higher resolution on the x-axis
  theme(text = element_text(size = 15), legend.position = "top",
        axis.text.x = element_text(angle = 90, hjust = 1), # rotate axis labels
        axis.title.x = element_text(vjust = -1), # add padding fo titles (also need to adjust the margins)
        axis.title.y = element_text(vjust = 3),
        plot.margin = unit(c(5.5, 5.5, 10, 10), "points")) 
```

# Now make a map of where the studies have been conducted

```{r}
# bring in world shape
world <- ne_countries(scale = "medium", returnclass = "sf")

# bring in shapefiles from Spalding et al. on marine bioregions
meow_ecos <- read_sf(here("data", "MEOW-TNC"), layer = "meow_ecos")

# check projection
st_crs(meow_ecos) # WGS 84

# plot the different realms (might be most useful for our purposes)
ggplot() +
  geom_sf(data = meow_ecos, aes(fill = REALM), size = 0.05) +
  geom_sf(data = world, fill = "darkgray", color = "black", size = 0.05) + # background color for continents (gray with a border)
  theme_classic()
```

To figure out which areas match with which:

```{r}
tmap_mode("view")

tm_shape(meow_ecos) + # this uses leaflet behind the scenes
  tm_polygons("ECOREGION", legend.show = FALSE) +
  tm_shape(world) +
  tm_polygons("admin", legend.show = FALSE) 
```

Bring in the csv with the regions matched to the papers. Note that **if there were multiple ECOREGIONS studied a paper could be counted multiple times (once for each ECOREGION)**

```{r}
ecoregions <- read_csv(here("data", "Corallivore_spatial.csv"))

# get count per ecoregion
ecoreg_sum <- ecoregions %>% 
  group_by(Country_ecoregion) %>% 
  summarize(Num_studies = n()) %>% 
  mutate(ECOREGION = Country_ecoregion)

# join to the dataset for plotting
meow_pub <- meow_ecos %>% 
  left_join(ecoreg_sum, by = "ECOREGION")

# plot results
ecoreg_plt <- ggplot() +
  geom_sf(data = meow_pub, aes(fill = Num_studies), color = NA, size = 0) +
  geom_sf(data = world, fill = "black", color = "black", size = 0.05) + # background color for continents (gray with a border)
  theme_bw() +
  scale_fill_gradient(name = "Number of studies", 
                      low = brewer.pal(n = 3, name = "YlOrRd")[1], 
                      high = brewer.pal(n = 3, name = "YlOrRd")[3], 
                      na.value = NA, breaks = seq(1, 14, by = 2)) +
  theme(text = element_text(size = 15)) +
  coord_sf(xlim = c(-180, 180), ylim = c(-45, 45), expand = FALSE) # crop the view so get a better look

# if you want to color the oceans:
# theme(panel.background = element_rect(fill = "aliceblue"))
  
```

Or plot by the realm (note **if this is actually the map we use we need to remove duplicate rows that were made for different ecoregions within the same realm**)

```{r}
# get count per realm
realm_pub <- meow_pub %>% 
  select(REALM, Num_studies) %>% 
  group_by(REALM) %>% 
  summarize(Num_studies = sum(Num_studies, na.rm = TRUE)) 
  
# plot results
ggplot() +
  geom_sf(data = realm_pub, aes(fill = Num_studies), size = 0.0) +
  geom_sf(data = world, fill = "darkgray", color = "black", size = 0.05) + # background color for continents (gray with a border)
  scale_fill_gradient(name = "Number of studies", low = brewer.pal(n = 3, name = "YlOrRd")[1], high = brewer.pal(n = 3, name = "YlOrRd")[3], na.value = NA) + 
  theme_classic() +
  theme(legend.position = 'bottom')
```

# Combine figures using `patchwork`

```{r}
# to save as pdf() run this chunk without hashtags
# pdf("study_timeplace.pdf", width = 15, height = 5)
time_plt + ecoreg_plt +
   plot_annotation(tag_levels = list(c("(A)", "(B)")))

# dev.off()
```





